/**
 * performanceInit.js - Inicializador del sistema de auditor√≠a de rendimiento
 * Configura y activa todas las herramientas de an√°lisis de performance
 */

import autoInstrument from './autoInstrument';
import { performance } from './developmentLogger';
import performanceAudit from './performanceAudit';
import renderAnalysis from './renderAnalysis';
import renderTracker from './renderTracker';

class PerformanceInit {
  constructor() {
    this.isInitialized = false;
    this.config = {
      enableAutoInstrument: true,
      enableRealTimeMonitor: true,
      autoStartTracking: true,
      reportInterval: 5000,
      logLevel: 'info', // 'debug', 'info', 'warn', 'error'
    };
  }

  /**
   * Inicializa el sistema completo de auditor√≠a de rendimiento
   * @param {Object} customConfig - Configuraci√≥n personalizada
   */
  async initialize(customConfig = {}) {
    if (this.isInitialized) {
      // eslint-disable-next-line no-console
      console.warn('‚ö†Ô∏è Sistema de auditor√≠a ya inicializado');
      return;
    }

    // Combinar configuraci√≥n
    this.config = { ...this.config, ...customConfig };

    performance('üöÄ INICIALIZANDO SISTEMA DE AUDITOR√çA DE RENDIMIENTO');
    performance('='.repeat(60));

    try {
      // 1. Configurar render tracker
      await this.setupRenderTracker();

      // 2. Configurar auto-instrumentaci√≥n
      if (this.config.enableAutoInstrument) {
        await this.setupAutoInstrumentation();
      }

      // 3. Configurar an√°lisis autom√°tico
      await this.setupAnalysis();

      // 4. Configurar herramientas globales
      await this.setupGlobalTools();

      // 5. Iniciar tracking autom√°tico si est√° habilitado
      if (this.config.autoStartTracking) {
        await this.startTracking();
      }

      this.isInitialized = true;
      // eslint-disable-next-line no-console
      console.log('‚úÖ SISTEMA DE AUDITOR√çA INICIALIZADO CORRECTAMENTE');
      // eslint-disable-next-line no-console
      console.log('='.repeat(60));

      // Mostrar comandos disponibles
      this.showAvailableCommands();
    } catch (error) {
      // eslint-disable-next-line no-console
      console.error('‚ùå Error inicializando sistema de auditor√≠a:', error);
      throw error;
    }
  }

  /**
   * Configura el render tracker
   */
  async setupRenderTracker() {
    // eslint-disable-next-line no-console
    console.log('üìä Configurando Render Tracker...');

    // Configurar l√≠mites y opciones
    renderTracker.setOptions({
      maxLogEntries: 1000,
      reportInterval: this.config.reportInterval,
      enableDetailedLogging: this.config.logLevel === 'debug',
    });

    // Silenciar componentes bien optimizados para reducir ruido en consola
    renderTracker.silenceWellOptimizedComponents();

    // eslint-disable-next-line no-console
    console.log('   ‚úì Render Tracker configurado');
  }

  /**
   * Configura la auto-instrumentaci√≥n
   */
  async setupAutoInstrumentation() {
    // eslint-disable-next-line no-console
    console.log('üîß Configurando Auto-Instrumentaci√≥n...');

    autoInstrument.enable();
    autoInstrument.setupCommonPatterns();

    // eslint-disable-next-line no-console
    console.log('   ‚úì Auto-Instrumentaci√≥n habilitada');
  }

  /**
   * Configura el sistema de an√°lisis
   */
  async setupAnalysis() {
    // eslint-disable-next-line no-console
    console.log('üß† Configurando Sistema de An√°lisis...');

    // Configurar thresholds personalizados si es necesario
    renderAnalysis.setThresholds({
      excellent: 0.5,
      good: 1,
      needsAttention: 2,
      poor: 3,
    });

    // eslint-disable-next-line no-console
    console.log('   ‚úì Sistema de An√°lisis configurado');
  }

  /**
   * Configura herramientas globales en window
   */
  async setupGlobalTools() {
    // eslint-disable-next-line no-console
    console.log('üåê Configurando Herramientas Globales...');

    // Comandos principales
    globalThis.perf = {
      // Auditor√≠a
      startAudit: (options) => performanceAudit.startAudit(options),
      stopAudit: () => performanceAudit.stopAudit(),
      getResults: () => performanceAudit.exportResults(),

      // Tracking
      startTracking: () => renderTracker.startAutoReporting(this.config.reportInterval),
      stopTracking: () => renderTracker.stopAutoReporting(),
      getStats: () => renderTracker.getAllStats(),
      reset: () => renderTracker.reset(),

      // An√°lisis
      analyze: (componentName) => {
        const stats = renderTracker.getAllStats();
        const componentStats = stats.find((s) => s.component === componentName);
        return componentStats
          ? renderAnalysis.analyzeComponent(componentName, componentStats)
          : undefined;
      },
      generatePlan: () => {
        const stats = renderTracker.getAllStats();
        const analyses = stats.map((stat) => renderAnalysis.analyzeComponent(stat.component, stat));
        return renderAnalysis.generateOptimizationPlan(analyses);
      },

      // Auto-instrumentaci√≥n
      instrument: (components) => autoInstrument.instrumentComponents(components),
      detectHigh: () => autoInstrument.detectHighRenderComponents(),
      report: () => autoInstrument.generateInstrumentationReport(),

      // Utilidades
      summary: () => performanceAudit.getQuickSummary(),
      help: () => this.showHelp(),
    };

    // Comandos de conveniencia adicionales
    globalThis.startPerf = globalThis.perf.startAudit;
    globalThis.stopPerf = globalThis.perf.stopAudit;
    globalThis.perfStats = globalThis.perf.getStats;
    globalThis.perfSummary = globalThis.perf.summary;

    // eslint-disable-next-line no-console
    console.log('   ‚úì Herramientas globales configuradas');
  }

  /**
   * Inicia el tracking autom√°tico
   */
  async startTracking() {
    // eslint-disable-next-line no-console
    console.log('‚ñ∂Ô∏è Iniciando Tracking Autom√°tico...');

    renderTracker.startAutoReporting(this.config.reportInterval);

    // eslint-disable-next-line no-console
    console.log(`   ‚úì Tracking iniciado (reportes cada ${this.config.reportInterval / 1000}s)`);
  }

  /**
   * Muestra comandos disponibles
   */
  showAvailableCommands() {
    // eslint-disable-next-line no-console
    console.log('\nüî†Ô∏è COMANDOS DISPONIBLES:');
    // eslint-disable-next-line no-console
    console.log('');
    // eslint-disable-next-line no-console
    console.log('üìä AUDITOR√çA COMPLETA:');
    // eslint-disable-next-line no-console
    console.log('   perf.startAudit()           - Iniciar auditor√≠a de 30s');
    // eslint-disable-next-line no-console
    console.log('   perf.startAudit({duration: 60000}) - Auditor√≠a personalizada');
    // eslint-disable-next-line no-console
    console.log('   perf.stopAudit()            - Detener auditor√≠a');
    // eslint-disable-next-line no-console
    console.log('   perf.getResults()           - Exportar resultados');
    // eslint-disable-next-line no-console
    console.log('');
    // eslint-disable-next-line no-console
    console.log('üìà TRACKING EN TIEMPO REAL:');
    // eslint-disable-next-line no-console
    console.log('   perf.getStats()             - Ver estad√≠sticas actuales');
    // eslint-disable-next-line no-console
    console.log('   perf.summary()              - Resumen r√°pido');

    // eslint-disable-next-line no-console
    console.log('   perf.reset()                - Resetear contadores');
    // eslint-disable-next-line no-console
    console.log('');
    // eslint-disable-next-line no-console
    console.log('üß† AN√ÅLISIS Y OPTIMIZACI√ìN:');
    // eslint-disable-next-line no-console
    console.log('   perf.analyze("ComponentName") - Analizar componente espec√≠fico');
    // eslint-disable-next-line no-console
    console.log('   perf.generatePlan()         - Generar plan de optimizaci√≥n');
    // eslint-disable-next-line no-console
    console.log('   perf.detectHigh()           - Detectar componentes problem√°ticos');
    // eslint-disable-next-line no-console
    console.log('');
    // eslint-disable-next-line no-console
    console.log('üîß AUTO-INSTRUMENTACI√ìN:');
    // eslint-disable-next-line no-console
    console.log('   perf.instrument({...})      - Instrumentar componentes');
    // eslint-disable-next-line no-console
    console.log('   perf.report()               - Reporte de instrumentaci√≥n');
    // eslint-disable-next-line no-console
    console.log('');
    // eslint-disable-next-line no-console
    console.log('‚ö° COMANDOS R√ÅPIDOS:');
    // eslint-disable-next-line no-console
    console.log('   startPerf()                 - Alias para perf.startAudit()');
    // eslint-disable-next-line no-console
    console.log('   stopPerf()                  - Alias para perf.stopAudit()');
    // eslint-disable-next-line no-console
    console.log('   perfStats()                 - Alias para perf.getStats()');
    // eslint-disable-next-line no-console
    console.log('   perfSummary()               - Alias para perf.summary()');
    // eslint-disable-next-line no-console
    console.log('');
  }

  /**
   * Muestra ayuda detallada
   */
  showHelp() {
    // eslint-disable-next-line no-console
    console.log(`\n${'='.repeat(60)}`);
    // eslint-disable-next-line no-console
    console.log('üìö GU√çA DE USO DEL SISTEMA DE AUDITOR√çA DE RENDIMIENTO');
    // eslint-disable-next-line no-console
    console.log('='.repeat(60));
    // eslint-disable-next-line no-console
    console.log('');
    // eslint-disable-next-line no-console
    console.log('üéØ FLUJO RECOMENDADO:');
    // eslint-disable-next-line no-console
    console.log('');
    // eslint-disable-next-line no-console
    console.log('1. Ejecutar auditor√≠a completa:');
    // eslint-disable-next-line no-console
    console.log('   startPerf({duration: 30000})  // 30 segundos');
    // eslint-disable-next-line no-console
    console.log('');
    // eslint-disable-next-line no-console
    console.log('2. Revisar resultados:');
    // eslint-disable-next-line no-console
    console.log('   perf.getResults()             // Ver reporte completo');
    // eslint-disable-next-line no-console
    console.log('');
    // eslint-disable-next-line no-console
    console.log('3. Analizar componentes cr√≠ticos:');
    // eslint-disable-next-line no-console
    console.log('   perf.detectHigh()             // Detectar problem√°ticos');
    // eslint-disable-next-line no-console
    console.log('   perf.analyze("ComponentName") // An√°lisis detallado');
    // eslint-disable-next-line no-console
    console.log('');
    // eslint-disable-next-line no-console
    console.log('4. Generar plan de optimizaci√≥n:');
    // eslint-disable-next-line no-console
    console.log('   perf.generatePlan()           // Plan autom√°tico');
    // eslint-disable-next-line no-console
    console.log('');
    // eslint-disable-next-line no-console
    console.log('üîç MONITOREO CONTINUO:');
    // eslint-disable-next-line no-console
    console.log('   perfSummary()                 // Estado actual');
    // eslint-disable-next-line no-console
    console.log('   perfStats()                   // Estad√≠sticas detalladas');
    // eslint-disable-next-line no-console
    console.log('');
    // eslint-disable-next-line no-console
    console.log('‚öôÔ∏è CONFIGURACI√ìN:');
    // eslint-disable-next-line no-console
    console.log('   El monitor visual est√° disponible en la esquina superior derecha');
    // eslint-disable-next-line no-console
    console.log('   Los componentes ya est√°n instrumentados autom√°ticamente');
    // eslint-disable-next-line no-console
    console.log('');
    // eslint-disable-next-line no-console
    console.log('='.repeat(60));
  }

  /**
   * Ejecuta una auditor√≠a de demostraci√≥n
   */
  async runDemo() {
    // eslint-disable-next-line no-console
    console.log('üé¨ EJECUTANDO DEMO DE AUDITOR√çA...');

    // Auditor√≠a corta de 10 segundos
    const results = await performanceAudit.startAudit({
      duration: 10_000,
      reportInterval: 2000,
      autoOptimize: true,
    });

    // eslint-disable-next-line no-console
    console.log('üé¨ DEMO COMPLETADA');
    return results;
  }

  /**
   * Verifica el estado del sistema
   */
  healthCheck() {
    const health = {
      initialized: this.isInitialized,
      renderTracker: renderTracker.isActive(),
      autoInstrument: autoInstrument.isEnabled,
      componentsTracked: renderTracker.getAllStats().length,
      timestamp: new Date().toISOString(),
    };

    // eslint-disable-next-line no-console
    console.log('üè• HEALTH CHECK:', health);
    return health;
  }

  /**
   * Limpia y resetea completo el sistema
   */
  cleanup() {
    // eslint-disable-next-line no-console
    console.log('üßπ LIMPIANDO SISTEMA DE AUDITOR√çA...');

    renderTracker.stopAutoReporting();
    renderTracker.reset();
    autoInstrument.disable();
    autoInstrument.clearInstrumentation();

    this.isInitialized = false;

    // eslint-disable-next-line no-console
    console.log('‚úÖ Sistema limpiado');
  }
}

// Instancia singleton
const performanceInit = new PerformanceInit();

// Auto-inicializaci√≥n en desarrollo
/* global process */
if (process.env.NODE_ENV === 'development') {
  // Inicializar autom√°ticamente despu√©s de un peque√±o delay
  setTimeout(() => {
    performanceInit.initialize({
      logLevel: 'info',
      autoStartTracking: true,
      reportInterval: 5000,
    });
  }, 1000);
}

// Exportar para uso manual
export default performanceInit;
